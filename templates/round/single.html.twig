{% extends 'base/page.html.twig' %}
{% from 'macros/badge.html.twig' import RoundBadge, ServerBadge %}
{% block breadcrumbs %}
	{{parent()}}
	<li class="breadcrumb-item" aria-current="page">
		<a href="{{url_for('rounds')}}" class="icon-link"><i class="fas fa-circle"></i>
		Rounds</li></a>
	<li class="breadcrumb-item">

		<i class="fas fa-circle"></i>
		{{round.getId}}
	</li>
{% endblock %}
{% block cardHeader %}
	<span>
		{{RoundBadge(round.getId)}}
		on
		{{ServerBadge(round.getServer)}}
	</span>
{% endblock %}
{% block cardSubHeader %}
	{% include 'round/components/roundStateBanner.html.twig' %}
{% endblock %}
{% block cardBody %}
	{% if 'In progress' != round.getState.value %}
		<table class="table table-bordered">
			<thead>
				{% if round.getName %}
					<tr>
						<td class="fw-bold h5" colspan="7">N.S.S.
							<em>{{round.getName}}</em>
							aboard
							{{round.getMap}}</td>
					</tr>
				{% endif %}
				{% if round.features.round_end_data %}
					<tr>
						<td colspan="7" id="integrity">
							<i class="fa-solid fa-spinner fa-spin"></i>
							Loading...
						</td>
					</tr>
				{% endif %}
			</thead>
			<tbody class="table-group-divider">
				<tr>
					<th>Round Initialized</th>
					{% if round.getStartDuration %}
						<td>Duration</td>
					{% endif %}
					<th>Round Started</th>
					{% if round.getDuration %}
						<td>Duration</td>
					{% endif %}
					<th>Round Ended</th>
					{% if round.getEndDuration %}
						<th>Duration</th>
					{% endif %}
					<th>Round Shutdown</th>
				</tr>
				<tr>
					<td>{{round.getInitDatetime ? round.getInitDatetime|date() : 'Not available'}}</td>
					{% if round.getStartDuration %}
						<td>{{round.getStartDuration}}</td>
					{% endif %}
					<td>{{round.getStartDatetime ? round.getStartDatetime|date() : 'Not available'}}</td>
					{% if round.getDuration %}
						<td>{{round.getDuration}}</td>
					{% endif %}
					<td>{{round.getEndDatetime ? round.getEndDatetime|date() : 'Not available'}}</td>
					{% if round.getEndDuration %}
						<td>{{round.getEndDuration}}</td>
					{% endif %}
					<td>{{round.getShutdownDatetime ? round.getShutdownDatetime|date() : 'Not available'}}</td>
				</tr>
			</tbody>
			<tfoot class="table-group-divider">
				<tr>
					<th>Public Logs</th>
					<td>
						<a class="icon-link" href="{{round.getPublicLogs}}" target="_blank">
							<i class="fas fa-external-link"></i>
							Round
							{{round.getId}}</a>
					</td>
					{% if user.has('ADMIN') %}
						<th>Admin Logs</th>
						<td>
							<a class="icon-link" href="{{round.getAdminLogs}}" target="_blank">
								<i class="fas fa-external-link"></i>
								Round
								{{round.getId}}</a>
						</td>
					{% endif %}
					<th>üêù Scrubby</th>
					<td colspan="{{user.has('ADMIN') ? 3 : 5}}">
						<a class="icon-link" href="https://scrubby.melonmesa.com/round/{{round.getId}}" target="_blank">
							<i class="fas fa-external-link"></i>
							Round
							{{round.getId}}</a>
					</td>
				</tr>
				<tr>
					<th>Github Commit</th>
					<td colspan="6">
						<a class="icon-link" target="_blank" href="https://github.com/tgstation/tgstation/commit/{{round.getCommit}}">
							<i class="fas fa-external-link"></i>
							{{round.getCommit}}</a>
					</td>
				</tr>
				<tr>
					<td colspan="7" style="background: #54487A;">
						<a class="icon-link link-light" href="https://www.gentoo.org/get-started/" target="_blank"><img src="/img/gentoo-3d-small.png" style="height: 1em; width: auto;"/>
							How to Install Gentoo</td>
					</td>
				</tr>
			</tfoot>
		</table>
	{% else %}
		<p class="text-center mb-0">¬´ This Round is Currently In Progress ¬ª</p>
	{% endif %}
	{% if user.has('ADMIN') %}
		{% include 'round/components/adminLinks.html.twig' %}
	{% endif %}
	{% include 'round/components/deaths.html.twig' %}
	{% include 'round/components/basic_stats.html.twig' %}
	{% include 'round/components/statlist.html.twig' %}
	{% if round.features.round_end_data %}
	<script>
	async function fetchExternalData() {
		const response = await fetch(`${window.location.href}sb_who?json`);
		var data = await response.json();
		data = data.stat.data
		const survivors = Object.keys(data.escapees.humans).length + Object.keys(data.escapees.silicons).length + Object.keys(data.escapees.others).length
		const abandoned = Object.keys(data.abandoned.humans).length + Object.keys(data.abandoned.silicons).length + Object.keys(data.abandoned.others).length
		const targetEl = document.getElementById('integrity')
		targetEl.innerHTML = `Station Integrity: ${data['additional data']['station integrity']}%, ${survivors} crew escaped, ${abandoned} left behind. <a href="${window.location.href}sb_who" class="icon-link"><i class="fa-solid fa-users-viewfinder"></i> Roster</a>`
	}
	fetchExternalData()
	</script>
	{% endif %}

{% endblock %}
