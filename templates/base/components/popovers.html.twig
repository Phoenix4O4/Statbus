<script src="https://unpkg.com/@popperjs/core@2"></script>
		<script src="https://unpkg.com/tippy.js@6"></script>
		<script>
      tippy(".playerBadge.has-popover", {
        content: "Loading...",
        onCreate(instance) {
          instance._isFetching = false;
          instance._src = null;
          instance._error = null;
        },
        onShow(instance) {
          if (instance._isFetching || instance._src || instance._error) {
            return;
          }
          const ckey = instance.reference.getAttribute("data-target-ckey");
          instance._isFetching = true;
		  {% if user.has('BAN') %}
          fetch(`/tgdb/player/${ckey}?format=popover`)
		  {% else %}
		  fetch(`/player/${ckey}?format=popover`)
		  {% endif %}
            .then((response) => response.text())
            .then((html) => {
              parser = new DOMParser();
              html = parser.parseFromString(html, 'text/html')
              instance.setContent(html.body.outerHTML)
            })
            .catch((error) => {
              instance._error = error;
              instance.setContent(`Request failed. ${error}`);
            })
            .finally(() => {
              instance._isFetching = false;
            });
        },
        onHidden(instance) {
          instance.setContent("Loading...");
          instance._src = null;
          instance._error = null;
        },
        allowHTML: true,
        interactive: true,
        {% if debug %}
        hideOnClick: 'toggle',
        trigger: 'click',
        {% endif %}
      });
	  </script>