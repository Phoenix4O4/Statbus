<!doctype html>
<html lang="en">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width, initial-scale=1">
		<title>
			{% block title %}Statbus
			{% endblock %}
		</title>
		{# <link href="/build/app.css?{{" now"|date('u')}}" rel="stylesheet"> #}

		{% block stylesheets %}
			{{ webpack_entry_link_tags('app') }}
		{% endblock %}

		{% block scripts %}
			{{ webpack_entry_script_tags('app') }}
		{% endblock %}
	</head>
	<body data-bs-theme="dark">
		{% for label, messages in flash %}
			{% for message in messages %}
				<div class="alert text-bg-{{label}} flash flash-{{ label }} alert-dismissible fade show" data-bs-dismiss="alert">
					<div class="{{narrow is defined ? 'container' : 'container-fluid'}} d-flex justify-content-between align-items-center">
						<span>{{ message }}</span>
						<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
					</div>
				</div>
			{% endfor %}
		{% endfor %}
		<nav class="navbar navbar-expand-lg tgui {{debug ? 'text-bg-danger' }}" style="--bs-bg-opacity: .5;" data-bs-theme="dark">
			<div class="{{narrow is defined ? 'container' : 'container-fluid'}}">
				<a href="{{url_for('home')}}" style="height: 40px; width: 40px;" id="site-logo">
					{{include('assets/statbus-star.svg')}}
				</a>
				{% if debug %}
					<span class="badge text-bg-danger ms-2">DEV</span>
				{% endif %}
				<button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse" id="navbarSupportedContent">
					<ul class="navbar-nav me-auto mb-2 mb-lg-0">
					{% if user %}
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fa-solid fa-person"></i> My Data
							</a>
							<ul class="dropdown-menu">
								<li>
									<a class="dropdown-item" href="{{url_for('user.bans')}}"><i class="fa-solid fa-gavel"></i> My Bans</a>
								</li>
								<li>
									<a class="dropdown-item" href="{{url_for('user.tickets')}}"><i class="fa-solid fa-ticket"></i> My Tickets</a>
								</li>
								<li>
									<a class="dropdown-item" href="{{url_for('user.notes')}}"><i class="fa-solid fa-envelope"></i> My Notes & Messages</a>
								</li>
							</ul>
						</li>
						{% endif %}
						<li class="nav-item dropdown">
							<a class="nav-link dropdown-toggle" href="#" role="button" data-bs-toggle="dropdown" aria-expanded="false">
								<i class="fa-solid fa-circle-info"></i> Info
							</a>
							<ul class="dropdown-menu">
								<li>
									<a class="dropdown-item" href="{{url_for('admins')}}"><i class="fa-solid fa-users"></i> Admin Roster</a>
								</li>
							</ul>
						</li>
					</ul>
					{% include 'base/components/authMenu.html.twig' %}
				</div>
			</div>
		</nav>
		<main class="{{narrow is defined ? 'container' : 'container-fluid'}}">

			{% block body %}{% endblock %}
			<footer class="{{narrow is defined ? 'container' : 'container-fluid'}} py-2 px-0 text-muted d-flex justify-content-between border-top border-2 mt-2">
				<span>{{app.name}}
					{{app.version}}
					|
					<a href="{{url_for('changelog')}}">Changelog</a>
					|
					<a href="{{url_for('privacy')}}">Privacy Policy</a>
				</span>
				<span>
					<a class="icon-link" href="https://github.com/{{app.github}}" target="_blank">
						<i class="fab fa-github" aria-hidden="true"></i>
						Github</a>
					<img src="https://github.com/{{app.github}}/actions/workflows/main.yml/badge.svg?event=push"/>
					|
					<a class="icon-link" href="{{url_for('discord')}}" target="_blank">
						<i class="fab fa-discord" aria-hidden="true"></i>
						Discord</a>
					|
					<a class="icon-link" href="{{app.patreon}}" target="_blank">
						<i class="fab fa-patreon" aria-hidden="true"></i>
						Patreon</a>
				</span>
			</footer>
		</main>
		{% if debug %}
			{{dump()}}
		{% endif %}
		<script src="https://unpkg.com/@popperjs/core@2"></script>
		<script src="https://unpkg.com/tippy.js@6"></script>
		{% if user.has('BAN') %}
		<script>
      tippy(".playerBadge.has-popover", {
        content: "Loading...",
        onCreate(instance) {
          // Setup our own custom state properties
          instance._isFetching = false;
          instance._src = null;
          instance._error = null;
        },
        onShow(instance) {
          if (instance._isFetching || instance._src || instance._error) {
            return;
          }
          const ckey = instance.reference.getAttribute("data-target-ckey");
          instance._isFetching = true;
          fetch(`/tgdb/player/${ckey}?format=popover`)
            .then((response) => response.text())
            .then((html) => {
              parser = new DOMParser();
              html = parser.parseFromString(html, 'text/html')
            //   const timestamps = html.querySelectorAll("time");
            //   timestamps.forEach(function (ts) {
            //     ts.setAttribute("title", ts.textContent);
            //     ts.textContent = dayjs(ts.textContent).utc().fromNow();
            //   });
              instance.setContent(html.body.outerHTML)
            })
            .catch((error) => {
              instance._error = error;
              instance.setContent(`Request failed. ${error}`);
            })
            .finally(() => {
              instance._isFetching = false;
            });
        },
        onHidden(instance) {
          instance.setContent("Loading...");
          // Unset these properties so new network requests can be initiated
          instance._src = null;
          instance._error = null;
        },
        allowHTML: true,
        interactive: true,
        {% if debug %}
        hideOnClick: 'toggle',
        trigger: 'click',
        {% endif %}
      });
	  </script>
	  {% else %}
	  <script>
		tippy("[data-bs-toggle=tooltip]", {
        content(reference) {
          const title = reference.getAttribute("data-bs-title");
          reference.removeAttribute("data-bs-title");
          return title;
        },
      });
	  </script>
	  {% endif %}
	</body>
</html>
